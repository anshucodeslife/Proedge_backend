generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  studentId         String?  @unique
  email             String   @unique
  passwordHash      String
  fullName          String
  role              Role     @default(STUDENT)
  status            Status   @default(ACTIVE)
  studentIdVerified Boolean  @default(false)
  isPreApproved     Boolean  @default(false)
  otpCode           String?
  otpExpiry         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  enrollments       Enrollment[]
  attendance        Attendance[]
  watchLogs         WatchLog[]
  notifications     Notification[]
}

model Course {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String?
  thumbnail   String?
  price       Float    @default(0)
  currency    String   @default("INR")
  isPaid      Boolean  @default(false)
  validityDays Int?
  modules     Module[]
  batches     Batch[]
  enrollments Enrollment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Module {
  id        String   @id @default(uuid())
  title     String
  order     Int
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  String
  lessons   Lesson[]
}

model Lesson {
  id             String   @id @default(uuid())
  title          String
  order          Int
  videoUrl       String?
  durationSec    Int?
  attachments    Json?
  module         Module   @relation(fields: [moduleId], references: [id])
  moduleId       String
  watchLogs      WatchLog[]
  batchVideoMaps BatchVideoMap[]
}

model Batch {
  id             String   @id @default(uuid())
  name           String
  tutorName      String?
  course         Course   @relation(fields: [courseId], references: [id])
  courseId       String
  priceOverride  Float?
  startDate      DateTime?
  endDate        DateTime?
  enrollments    Enrollment[]
  attendance     Attendance[]
  batchVideoMaps BatchVideoMap[]
}

model Enrollment {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  course     Course   @relation(fields: [courseId], references: [id])
  courseId   String
  batch      Batch?   @relation(fields: [batchId], references: [id])
  batchId    String?
  status     EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime @default(now())
  expiresAt  DateTime?
  payments   Payment[]
  history    EnrollmentHistory[]
}

model Attendance {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  batch        Batch    @relation(fields: [batchId], references: [id])
  batchId      String
  date         DateTime
  status       AttendanceStatus
  autoMarked   Boolean  @default(false)
  watchPercent Float?
  overriddenBy String?
  overrideNote String?
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([batchId])
  @@index([date])
}

model WatchLog {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  lesson       Lesson   @relation(fields: [lessonId], references: [id])
  lessonId     String
  watchedSec   Int      @default(0)
  lastPosition Int      @default(0)
  percentage   Float    @default(0)
  completed    Boolean  @default(false)
  events       Json?    // {play: [], pause: [], seek: []}
  sessionCount Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Payment {
  id                String   @id @default(uuid())
  orderId           String   @unique
  paymentId         String?
  provider          String   @default("razorpay")
  providerPaymentId String?
  amount            Float
  currency          String   @default("INR")
  status            PaymentStatus
  razorpaySignature String?
  enrollment        Enrollment? @relation(fields: [enrollmentId], references: [id])
  enrollmentId      String?
  invoice           Invoice?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([enrollmentId])
  @@index([status])
}

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  discountType DiscountType
  discountValue Float
  validFrom   DateTime?
  validTo     DateTime?
  maxUses     Int?
  usageCount  Int @default(0)
}

model EnrollmentHistory {
  id           String   @id @default(uuid())
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  enrollmentId String
  action       String
  note         String?
  actor        String
  createdAt    DateTime @default(now())
}

model PreApprovedStudent {
  id        String   @id @default(uuid())
  studentId String   @unique
  fullName  String
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  
  @@index([studentId])
}

model BatchVideoMap {
  id        String   @id @default(uuid())
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  batchId   String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId  String
  videoUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([batchId, lessonId])
  @@index([batchId])
  @@index([lessonId])
}

model Notification {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  sentAt    DateTime @default(now())
  
  @@index([userId])
  @@index([read])
  @@index([sentAt])
}

model Invoice {
  id        String   @id @default(uuid())
  payment   Payment  @relation(fields: [paymentId], references: [id])
  paymentId String   @unique
  invoiceNo String   @unique
  amount    Float
  tax       Float    @default(0)
  total     Float
  pdfUrl    String?
  createdAt DateTime @default(now())
  
  @@index([invoiceNo])
}

enum Role {
  ADMIN
  STUDENT
  TUTOR
}

enum Status {
  ACTIVE
  INACTIVE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ON_LEAVE
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum NotificationType {
  EMAIL
  PUSH
  IN_APP
}
