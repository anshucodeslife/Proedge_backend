generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  studentId    String?  @unique
  email        String   @unique
  passwordHash String
  fullName     String
  role         Role     @default(STUDENT)
  status       Status   @default(ACTIVE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  enrollments  Enrollment[]
  attendance   Attendance[]
  watchLogs    WatchLog[]
}

model Course {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String?
  thumbnail   String?
  price       Float    @default(0)
  currency    String   @default("INR")
  isPaid      Boolean  @default(false)
  validityDays Int?
  modules     Module[]
  batches     Batch[]
  enrollments Enrollment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Module {
  id        String   @id @default(uuid())
  title     String
  order     Int
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  String
  lessons   Lesson[]
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  order       Int
  videoUrl    String?
  durationSec Int?
  attachments Json?
  module      Module   @relation(fields: [moduleId], references: [id])
  moduleId    String
  watchLogs   WatchLog[]
}

model Batch {
  id         String   @id @default(uuid())
  name       String
  tutorName  String?
  course     Course   @relation(fields: [courseId], references: [id])
  courseId   String
  priceOverride Float?
  startDate  DateTime?
  endDate    DateTime?
  enrollments Enrollment[]
  attendance  Attendance[]
}

model Enrollment {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  course     Course   @relation(fields: [courseId], references: [id])
  courseId   String
  batch      Batch?   @relation(fields: [batchId], references: [id])
  batchId    String?
  status     EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime @default(now())
  expiresAt  DateTime?
  payments   Payment[]
  history    EnrollmentHistory[]
}

model Attendance {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  batch     Batch    @relation(fields: [batchId], references: [id])
  batchId   String
  date      DateTime
  status    AttendanceStatus
  createdAt DateTime @default(now())
}

model WatchLog {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  lesson     Lesson   @relation(fields: [lessonId], references: [id])
  lessonId   String
  watchedSec Int      @default(0)
  events     Json?
  updatedAt  DateTime @updatedAt
}

model Payment {
  id                String   @id @default(uuid())
  provider          String
  providerPaymentId String?
  amount            Float
  currency          String  @default("INR")
  status            PaymentStatus
  enrollment        Enrollment? @relation(fields: [enrollmentId], references: [id])
  enrollmentId      String?
  createdAt         DateTime @default(now())
}

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  discountType DiscountType
  discountValue Float
  validFrom   DateTime?
  validTo     DateTime?
  maxUses     Int?
  usageCount  Int @default(0)
}

model EnrollmentHistory {
  id           String   @id @default(uuid())
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  enrollmentId String
  action       String
  note         String?
  actor        String
  createdAt    DateTime @default(now())
}

enum Role {
  ADMIN
  STUDENT
  TUTOR
}

enum Status {
  ACTIVE
  INACTIVE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ON_LEAVE
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENT
  FIXED
}
