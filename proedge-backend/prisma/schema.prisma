generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int       @id @default(autoincrement())
  studentId         String?   @unique
  email             String    @unique
  passwordHash      String
  fullName          String
  role              Role      @default(STUDENT)
  status            Status    @default(ACTIVE)
  studentIdVerified Boolean   @default(false)
  isPreApproved     Boolean   @default(false)
  otpCode           String?
  otpExpiry         DateTime?

  // Personal Info
  contact       String?
  dob           String?
  gender        String?
  address       String?
  parentName    String? @map("parent_name")
  parentContact String? @map("parent_contact")

  // Academic Info
  currentSchool  String? @map("current_school")
  classYear      String? @map("class_year")
  subjects       String?
  educationLevel String? @map("education_level")
  school         String?
  board          String?

  // Course Linking
  courseId    Int?    @map("course_id")
  course      Course? @relation(fields: [courseId], references: [id])
  courseName  String? @map("course_name")
  batchTiming String? @map("batch_timing")

  // Fees & Payment Info
  totalFees     Decimal? @map("total_fees")
  paidFees      Decimal? @default(0) @map("paid_fees")
  originalFees  Decimal? @map("original_fees")
  paymentMode   String?  @map("payment_mode")
  paymentOption String?  @map("payment_option")
  advanceAmount Decimal? @map("advance_amount")
  referenceNo   String?  @map("reference_no")

  // Installments
  installment1Amount Decimal? @map("installment1_amount")
  installment1Date   String?  @map("installment1_date")
  installment1Paid   Boolean  @default(false) @map("installment1_paid")

  installment2Amount Decimal? @map("installment2_amount")
  installment2Date   String?  @map("installment2_date")
  installment2Paid   Boolean  @default(false) @map("installment2_paid")

  installment3Amount Decimal? @map("installment3_amount")
  installment3Date   String?  @map("installment3_date")
  installment3Paid   Boolean  @default(false) @map("installment3_paid")

  // Referral
  referralCode   String?  @map("referral_code")
  referralAmount Decimal? @map("referral_amount")

  // Meta & Emergency
  studentSignature  String? @map("student_signature")
  parentSignature   String? @map("parent_signature")
  submissionDate    String? @map("submission_date")
  emergencyName     String? @map("emergency_name")
  emergencyRelation String? @map("emergency_relation")
  emergencyPhone    String? @map("emergency_phone")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? @map("deleted_at")

  enrollments   Enrollment[]
  attendance    Attendance[]
  watchLogs     WatchLog[]
  notifications Notification[]
}

model Course {
  id               Int               @id @default(autoincrement())
  title            String            @unique
  slug             String            @unique
  description      String?
  image            String?
  thumbnail        String?
  price            Decimal           @default(0)
  mrp              Decimal           @default(0)
  currency         String            @default("INR")
  isPaid           Boolean           @default(false)
  active           Boolean           @default(true)
  validityDays     Int?
  duration         String?
  lectures         String?
  projects         String?
  certificate      String?
  access           String?
  points           Json?             // Learning outcomes/points
  modules          Module[]
  batches          Batch[]
  enrollments      Enrollment[]
  students         User[]
  enquiries        Enquiry[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime? // Soft Delete
}

model Module {
  id       Int      @id @default(autoincrement())
  title    String
  order    Int
  course   Course   @relation(fields: [courseId], references: [id])
  courseId Int
  lessons  Lesson[]
}

model Lesson {
  id             Int             @id @default(autoincrement())
  title          String
  order          Int
  videoUrl       String?
  durationSec    Int?
  attachments    Json?
  module         Module          @relation(fields: [moduleId], references: [id])
  moduleId       Int
  watchLogs      WatchLog[]
  batchVideoMaps BatchVideoMap[]
}

model Batch {
  id             Int             @id @default(autoincrement())
  name           String
  tutorName      String?
  course         Course          @relation(fields: [courseId], references: [id])
  courseId       Int
  priceOverride  Float?
  startDate      DateTime?
  endDate        DateTime?
  enrollments    Enrollment[]
  attendance     Attendance[]
  batchVideoMaps BatchVideoMap[]
}

model Enrollment {
  id         Int                 @id @default(autoincrement())
  user       User                @relation(fields: [userId], references: [id])
  userId     Int
  course     Course              @relation(fields: [courseId], references: [id])
  courseId   Int
  batch      Batch?              @relation(fields: [batchId], references: [id])
  batchId    Int?
  status     EnrollmentStatus    @default(ACTIVE)
  enrolledAt DateTime            @default(now())
  expiresAt  DateTime?
  payments   Payment[]
  history    EnrollmentHistory[]
}

model Attendance {
  id           Int              @id @default(autoincrement())
  user         User             @relation(fields: [userId], references: [id])
  userId       Int
  batch        Batch            @relation(fields: [batchId], references: [id])
  batchId      Int
  date         DateTime
  status       AttendanceStatus
  autoMarked   Boolean          @default(false)
  watchPercent Float?
  overriddenBy String?
  overrideNote String?
  createdAt    DateTime         @default(now())

  @@index([userId])
  @@index([batchId])
  @@index([date])
}

model WatchLog {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id])
  userId       Int
  lesson       Lesson   @relation(fields: [lessonId], references: [id])
  lessonId     Int
  watchedSec   Int      @default(0)
  lastPosition Int      @default(0)
  percentage   Float    @default(0)
  completed    Boolean  @default(false)
  events       Json? // {play: [], pause: [], seek: []}
  sessionCount Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Payment {
  id                Int           @id @default(autoincrement())
  orderId           String        @unique
  paymentId         String?
  provider          String        @default("razorpay")
  providerPaymentId String?
  amount            Float
  currency          String        @default("INR")
  status            PaymentStatus
  razorpaySignature String?
  enrollment        Enrollment?   @relation(fields: [enrollmentId], references: [id])
  enrollmentId      Int?
  invoice           Invoice?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([enrollmentId])
  @@index([status])
}

model Coupon {
  id            Int          @id @default(autoincrement())
  code          String       @unique
  discountType  DiscountType
  discountValue Float
  validFrom     DateTime?
  validTo       DateTime?
  maxUses       Int?
  usageCount    Int          @default(0)
}

model EnrollmentHistory {
  id           Int        @id @default(autoincrement())
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  enrollmentId Int
  action       String
  note         String?
  actor        String
  createdAt    DateTime   @default(now())
}

model PreApprovedStudent {
  id        Int      @id @default(autoincrement())
  studentId String   @unique
  fullName  String
  email     String?
  phone     String?
  createdAt DateTime @default(now())

  @@index([studentId])
}

model BatchVideoMap {
  id        Int      @id @default(autoincrement())
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  batchId   Int
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId  Int
  videoUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([batchId, lessonId])
  @@index([batchId])
  @@index([lessonId])
}

model Notification {
  id      Int              @id @default(autoincrement())
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  Int
  type    NotificationType
  title   String
  message String
  data    Json?
  read    Boolean          @default(false)
  sentAt  DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([sentAt])
}

model Invoice {
  id        Int      @id @default(autoincrement())
  payment   Payment  @relation(fields: [paymentId], references: [id])
  paymentId Int      @unique
  invoiceNo String   @unique
  amount    Float
  tax       Float    @default(0)
  total     Float
  pdfUrl    String?
  createdAt DateTime @default(now())

  @@index([invoiceNo])
}

// --- Merged Models from proedgelearning-main ---

model SystemSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String
  entity      String
  entityId    String?
  details     String?
  performedBy String?
  createdAt   DateTime @default(now())
}

model Referral {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  discount  Decimal   @default(5.0)
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?


}



model Enquiry {
  id                Int     @id @default(autoincrement())
  fullName          String
  email             String
  contact           String
  dob               String?
  gender            String?
  educationLevel    String?
  preferredCourses  String?
  otherCourse       String?
  batchTiming       String?
  emergencyName     String?
  emergencyRelation String?
  emergencyPhone    String?

  courseId Int?
  course   Course? @relation(fields: [courseId], references: [id])

  status    String    @default("NEW")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Internship {
  id          Int       @id @default(autoincrement())
  title       String
  company     String?
  description String?
  location    String?
  type        String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model VisitLog {
  id        Int      @id @default(autoincrement())
  ip        String
  userAgent String?  @map("user_agent")
  page      String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("visit_logs")
}

enum Role {
  ADMIN
  STUDENT
  TUTOR
  SUPERADMIN
}

enum Status {
  ACTIVE
  INACTIVE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ON_LEAVE
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum NotificationType {
  EMAIL
  PUSH
  IN_APP
}
